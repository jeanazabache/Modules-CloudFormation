parameters:
  sonarCloudBranch: ''
  sonarCloudToken: ''
  cliProjectKey: ''
steps:
  - script: echo "${{ parameters.sonarCloudBranch }}"
    displayName: 'Current "branch" status'
    
  - bash: |
      curl --location --request GET 'https://sonarcloud.io/api/measures/component_tree?metricKeys=alert_status,&component=${{ parameters.cliProjectKey }}&branch=${{ parameters.sonarCloudBranch }}' --header 'Authorization: Bearer ${{ parameters.sonarCloudToken }}' > metrics.json
      METRIC_STATUS=`echo $(jq -r --arg METRIC "alert_status" '.baseComponent.measures[] | select(.metric==$METRIC) | .value' metrics.json)`
      echo "##vso[task.setvariable variable=status;isOutput=true]$METRIC_STATUS"
    name: SonarCloudResponse
    displayName: SonarCloudGetStatus

  - script: |
      echo "##vso[task.logissue type=error]No cumple con las m√©tricas SONARCLOUD"
    displayName: 'SonarCloudStatusValidation'
    condition: eq(variables['SonarCloudResponse.status'], 'Error')